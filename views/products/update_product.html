{{extend 'base/layout.html'}}

{{block scripts_extra}}
<script type="text/javascript" src="{{=URL('static', 'js/plugins/jquery.maskedinput.js')}}"></script>
<script type="text/javascript" src="{{=URL('static', 'js/plugins/jquery.validate.min.js')}}"></script>
<script type="text/javascript" src="{{=URL('static', 'js/plugins/chosen.jquery.min.js')}}"></script>
<script type="text/javascript" src="{{=URL('static', 'js/plugins/jquery.dataTables.min.js')}}"></script>
<script type="text/javascript" src="{{=URL('static', 'js/custom/dualselector.js')}}"></script>
<style type="text/css">
    .ellol {
        border: 1px solid red;
    }    
</style>
{{end}}

{{block sidebar_menu}}
{{include 'products/sidebar.html'}}
{{end}}

{{block content}}
    <div class="centercontent">
    
        <div class="pageheader">
        
            <h1 class="pagetitle">{{=title}}</h1>
            
        </div><!--pageheader-->
        
        <div id="contentwrapper" class="contentwrapper">
        
        	<div id="validation" class="subcontent">
            	
            		<div class="contenttitle2">
                        <h3>Nuevo producto</h3>
                    </div><!--contenttitle-->
         
					<div class="notibar msgerror" style="display:none;">
                    	<a class="close"></a>
                    	<p>Ocurrió un error con los datos del formulario.</p>
                    </div>

                	<div class="notibar exists" style="display:none;">
                   		<a class="close"></a>
                    	<p>Este producto ya existe, para editarlo vaya a la sección de ver producto. </p>
                    </div>

                	<div class="notibar msgsuccess" style="display:none;">
                        <a class="close"></a>
                        <p>Se han guardado los datos del formulario.</p>
                    </div>
            	
                    <form id="form_product" class="stdform stdform2" method="post" action="">           	                        
                        <p>
	                        	<label>Nombre *</label>
	                            <span class="field"><input type="text" name="name" id="name" class="smallinput" tabindex="1"/></span>
	                    </p>
	                    <p>
	                        	<label>Nombre alternativo</label>
	                            <span class="field"><input type="text" name="alternative_name" id="alternative_name" class="smallinput" tabindex="2"/></span>
	                    </p>
	                    <p>
	                        	<label>Código alternativo</label>
	                            <span class="field"><input type="text" name="alternative_code" id="alternative_code" class="smallinput" tabindex="3"/></span>
	                    </p>
	                    <p style="margin-top: 1px;">
                            <label>Marca *</label>
                            <span class="field">
                                <select id="brands" name="brands" data-placeholder="Seleccionar" class="chzn-select" style="width:350px;" tabindex="4">
                                  </select>
                            </span>
                        </p>
                        <p style="margin-top: 1px;">
	                        	<label>Modelo</label>
	                            <span class="field"><input type="text" name="model" id="model" class="smallinput" tabindex="5"/></span>
	                    </p>
	                    <p style="margin-top: 1px;">
                            <label>Unidad de medida *</label>
                            <span class="field">
                                <select id="unit" name="unit" data-placeholder="Seleccionar" class="chzn-select" style="width:350px;" tabindex="6">
                                  </select>
                            </span>
                        </p>
                        <p style="margin-top: 1px;">
	                        	<label>Número de parte</label>
	                            <span class="field"><input type="text" name="part_number" id="part_number" class="smallinput" tabindex="7"/></span>
	                    </p>
	                    <p>
	                        	<label>Número de serie</label>
	                            <span class="field"><input type="text" name="serial_number" id="serial_number" class="smallinput" tabindex="8"/></span>
	                    </p>
	                    <p style="margin-top: 1px;">
                            <label>Categoría *</label>
                            <span class="field">
                                <select id="category" name="category" data-placeholder="Seleccionar" class="chzn-select" style="width:350px;" tabindex="9">
                                  </select>
                            </span>
                        </p>
	                    <p style="margin-top:1px;">
	                        	<label>Proveedores</label>
	                            <span class="field">
                            	<select name="vendors" id="vendors" multiple="multiple" size="10" data-placeholder="Seleccionar" class="chzn-select" tabindex="10"></select>
                               
                                </span>
	                    </p>
	                    <p>
	                        	<label>Costo estandar</label>
	                            <span class="field"><input type="text" name="standard_cost" id="standard_cost" class="smallinput" placeholder="0.00" tabindex="11"/></span>
	                    </p>
	                    <p>
	                        	<label>Margen de utilidad</label>
	                            <span class="field"><input type="text" name="markup" id="markup" class="smallinput" tabindex="12"/></span>
	                    </p>
	                    <p>
                        		<label>Descripción</label>
                        		<span class="field"><textarea cols="80" rows="5" name="description" id="description" class="smallinput" tabindex="13"></textarea></span>
                        </p>
	                    
                        <p class="stdformbutton">
                        	<button id="submit" class="submit radius2" tabindex="14">Guardar</button>
                        </p>
                        
                        
                    </form>
                   

            </div><!--subcontent-->     
        
        </div><!--contentwrapper-->
        
        <br clear="all" />
        
	</div><!-- centercontent -->
        
</div><!--bodywrapper-->

<script type="text/javascript">
{{id=request.vars.id}}
//////////// Ajax for selects ////////////
    jQuery(".chzn-select").chosen();

    var brand_id = jQuery('#brands'),
        unit_id = jQuery('#unit'),
        category_id = jQuery('#category');
        vendors = jQuery('#vendors');
        
    var b = '',
        u = '',
        c = '';
        
    var bid,
        uid,
        cid;

//////////// get info ////////////
    jQuery.ajax({
        url: "{{=URL(c='products_ajax', f='get_product_information')}}",
        data: { id: "{{=id}}" },
        type: "POST",
        dataType:"json",
        success:function(data){
            jQuery('#name').val(data.product_descriptions['name']);
            jQuery('#alternative_name').val(data.product_descriptions['alternative_name']);
            jQuery('#alternative_code').val(data.products['alternative_code']);
            jQuery('#model').val(data.products['model']);
            jQuery('#part_number').val(data.products['part_number']);
            jQuery('#serial_number').val(data.products['serial_number']);
            jQuery('#standard_cost').val(data.products['standard_cost']);
            jQuery('#markup').val(data.products['markup']);
            jQuery('#description').val(data.product_descriptions['description']);
            bid = (data.brand_descriptions['brand_id'] == null) ? '': data.brand_descriptions['brand_id'];
            uid = (data.units['id'] == null) ? '': data.units['id'];
            cid = (data.category_descriptions['category_id'] == null) ? '': data.category_descriptions['category_id'];
            selectBrands(bid);
            selectUnit(uid);
            selectCategory(cid);
            selectVendor(data.vendors);
        },
    });

//////////// get brands, units & categories ////////////



//////////// validate form ////////////
    jQuery("#form_product").validate({
            rules: {
                name: "required",
                standard_cost: {
                	number: true,
	                required: false
                },
                markup: {
                    number: true,
                    required: false
                },
            },
            messages: {
                name: "Ingrese el nombre del producto",
                standard_cost: "Ingrese numeros decimales",
                markup: "Ingrese numeros decimales"
            }
    });
    
//////////// send form ////////////
    jQuery('#submit').live('click', function(e) {
        e.preventDefault();
        
        valState(sid);
        valLoc(lid);
        valMun(mid);
        
        var sendid = '{{=request.vars.id}}';
        
        jQuery('.msgerror').hide();
        jQuery('.exists').hide();
        jQuery('.msgsuccess').hide();

        if(jQuery("#form_branch_office").valid() && sid != null && mid != null && lid != null && valState(sid) && valLoc(lid) && valMun(mid)) {
        console.log('in');
             jQuery.ajax({
                url: "{{=URL(c='common', f='echo')}}",
                data: { 
                	name:jQuery('#name').val(),
                    address:jQuery('#address').val(),
                    suburb:jQuery('#suburb').val(),
                    state: sid,
                    municipality: mid,
                    locality: lid,
                    zip_code:jQuery('#zip_code').val(),
                    business_name:jQuery('#business_name').val(),
                    rfc:jQuery('#rfc').val(),
                    tax:jQuery('#tax').val(),
                    id: sendid
                },
                type: 'POST',
                success:function(data){
                    if(data != 0 && data){
                        jQuery('.msgsuccess').fadeIn(1600, function() {
                            jQuery('.msgsuccess').fadeOut('slow');
                        });
                        sid, mid, lid = 0;
                        id = '';
                        setTimeout('redirect()', 1600);
                    }
                    else if(data == 0) {
                        jQuery('.exists').fadeIn(1600);
                    }
                    else{
                        jQuery('.msgerror').fadeIn(1600);
                    }
                    jQuery('body','html',window).animate(
                                                        {scrollTop:0}, 
                                                        1000);
                }
            }); 
        } else {
            jQuery('.msgerror').fadeIn(1600);
            jQuery('body','html',window, document).animate({scrollTop:0},1000);
        }
    });

    function selectBrands(id) {
        jQuery.ajax({
            type: "POST",
            url: "{{=URL(c='products_ajax', f='get_brands')}}",
            dataType: "json",
            success: function(data) {
                options = '';
                for(key in data){
                    val = data[key].brand_descriptions;
                    options += '<option value="' + val.brand_id + '">' + val.name + '</option>\n';
                }
                brand_id
                    .html(options)
                    .prepend('<option value="">Selecccionar</option>')
                    .trigger("liszt:updated");
                },
            complete: function() {
                brand_id
                    .find('option[value='+id+']').attr('selected',true)
                    .trigger("liszt:updated");
            }
        });
    }

    function selectUnit(id) {
        jQuery.ajax({
            type: "POST",
            url: "{{=URL(c='products_ajax', f='get_units')}}",
            dataType: "json",
            success: function(data) {
                options = '';
                for(key in data){
                    val = data[key];
                    options += '<option value="' + val.id + '">' + val.name + '</option>\n';
                }
                unit_id
                    .html(options)
                    .prepend('<option value="">Selecccionar</option>')
                    .trigger("liszt:updated");
                },
            complete: function() {
                unit_id
                    .find('option[value='+id+']').attr('selected',true)
                    .trigger("liszt:updated");
            }
        });
    }

    function selectCategory(id) {
        jQuery.ajax({
            type: "POST",
            url: "{{=URL(c='products_ajax', f='get_categories')}}",
            dataType: "json",
            success: function(data) {
                options = '';
                for(key in data){
                    val = data[key].category_descriptions;
                    options += '<option value="' + val.category_id + '">' + val.name + '</option>\n';
                }
                category_id
                    .html(options)
                    .prepend('<option value="">Selecccionar</option>')
                    .trigger("liszt:updated");
                },
            complete: function() {
                category_id
                    .find('option[value='+id+']').attr('selected',true)
                    .trigger("liszt:updated");
            }
        });
    }

    function selectVendor(ids) {
        jQuery.ajax({
            type: "POST",
            url: "{{=URL(c='vendors_ajax', f='get_vendors')}}",
            success: function(results) {
                vendors 
                    .html(results)
                    .trigger("liszt:updated");
            },
            complete: function() {
                for(k in ids) {
                    id = ids[k].id;
                    vendors
                        .find('option[value='+id+']').attr('selected',true)
                        .trigger("liszt:updated");
                }
            }
        });
    }

    function redirect() {
        window.location.replace("{{=URL(c='branches', f='branch_office')}}");
    }
    
    function valState(ss) {
    var bol;
    if (ss != 0) {
        bol = true;
        jQuery('#states').siblings('div').removeClass('ellol');
    } else if(ss != null){
        bol = false;
        jQuery('#states').siblings('div').addClass('ellol');
    } else{
        bol = false;
        jQuery('#states').siblings('div').addClass('ellol');
    };
    return bol
    }
    
    function valLoc(ss) {
    var bol;
    if (ss != 0) {
        bol = true;
        jQuery('#locality').siblings('div').removeClass('ellol');
    } else if(ss != null){
        bol = false;
        jQuery('#locality').siblings('div').addClass('ellol');
    } else{
        bol = false;
        jQuery('#locality').siblings('div').addClass('ellol');
    };
    return bol
    }
    
    function valMun(ss) {
    var bol;
    if (ss != 0) {
        bol = true;
        jQuery('#municipality').siblings('div').removeClass('ellol');
    } else if(ss != null){
        bol = false;
        jQuery('#municipality').siblings('div').addClass('ellol');
    } else{
        bol = false;
        jQuery('#municipality').siblings('div').addClass('ellol');
    };
    return bol
    }

    
</script>

</body>
</html>
{{end}}
