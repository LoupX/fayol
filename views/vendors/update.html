{{dashboard_current = ''}}
{{catalogs_current = 'current'}}
{{extend 'base/layout.html'}}

{{block scripts_extra}}	
<script type="text/javascript" src="{{=URL('static', 'js/plugins/jquery.validate.min.js')}}"></script>
{{end}}

{{block sidebar_menu}}
{{include 'vendors/sidebar.html'}}
{{end}}

{{block content}}
    <div class="centercontent">
    
        <div class="pageheader">
        
            <h1 class="pagetitle">{{=title}}</h1>
            
        </div><!--pageheader-->
        
        <div id="contentwrapper" class="contentwrapper">
            
                <div id="validation" class="subcontent">
                
                <div class="contenttitle2">
                        <h3>Datos generales</h3>
                </div><!--contenttitle-->
                
                    <form id="form" class="stdform stdform2" method="POST" action="">
                        <p>
                            <label>Nombre de la empresa *</label>
                            <span class="field"><input type="text" name="company" id="company" class="smallinput" value="{{=name}}" /></span>
                        </p>
                        
                        <p>
                            <label>Dirección</label>
                            <span class="field"><input type="text" name="address" id="address" class="smallinput" value="{{=address}}" /></span>
                        </p>

                        <p style="margin-top: 1px;">
                            <label>Estado</label>
                            <span class="field">
                                {{=states}}
                            </span>
                        </p>
                        
                        <p style="margin-top: 1px;">
                            <label>Municipio</label>
                            <span id="municipality_container"class="field">
                                {{=municipalities}}
                            </span>
                        </p>

                        <p style="margin-top: 1px;">
                            <label>Ciudad</label>
                            <span class="field" id="locality_container">
                                {{=localities}}
                            </span>
                        </p>
                        
                        <p style="margin-top: 1px;">
                            <label>Código postal</label>
                            <span class="field"><input type="text" name="zip_code" id="zip_code" class="smallinput" maxlength="5" value="{{=zip_code}}" /></span>
                        </p>
                        
                        <p>
                            <label>R.F.C.</label>
                            <span class="field"><input type="text" name="rfc" id="rfc" class="smallinput" maxlength="13" value="{{=rfc}}" /></span>
                        </p>
                        
                        <p>
                            <label>Sitio Web</label>
                            <span class="field"><input type="text" name="website" id="website" class="smallinput" value="{{=website}}" /></span>
                        </p>
                        
                        <p class="stdformbutton">
                            <button id="submit" class="submit radius2">Guardar </button>
                            <span class="msg" style="
                            display:none;
                            background: #FFFCCC;
                            color: #333;
                            margin-bottom: 10px;
                            padding: 5px;
                            text-align: center;
                            font-size: 13px;
                            -moz-border-radius: 2px;
                            -webkit-border-radius: 2px;
                            border-radius: 2px;
                            margin-left:30px;">
                            something happened
                            </span>
                        </p>
                    </form>

            </div><!--subcontent-->      
        
        </div><!--contentwrapper-->
        
        <br clear="all" />
        
    </div><!-- centercontent -->
    
    
</div><!--bodywrapper-->

<script type="text/javascript">
    //Ajax for selects
    var state = jQuery('#states'),
        municipality = jQuery('#municipality'),
        locality = jQuery('#locality');

    state.prepend('<option value="" selected>Selecccionar</option>');

    state.change( function() {
        var id = jQuery(this).find(':selected').val();
        if(id != '') {
            jQuery.ajax({
                type: "POST",
                url: '{{=URL('vendors', 'get_municipalities')}}',
                data: {id: id},
                success: function(results) {
                    municipality
                            .html(results)
                            .prepend('<option value="">Selecccionar</option>');
                }
            });
        }
        else {
            municipality
                    .html('')
                    .prepend('<option value="">Selecccionar</option>');
            locality
                    .html('')
                    .prepend('<option value="">Selecccionar</option>');
        }
    });

    municipality.change( function() {
        var id = jQuery(this).find(':selected').val();
        if(id != '') {
            jQuery.ajax({
                type: "POST",
                url: '{{=URL('vendors', 'get_localities')}}',
                data: {id: id},
                success: function(results) {
                    locality
                            .html(results)
                            .prepend('<option value="">Selecccionar</option>');
                }
            });
        }
        else {
            locality
                    .html('')
                    .prepend('<option value="">Selecccionar</option>');
        }
    });

    //form and shit
    

    //send form
    jQuery('#submit').live('click', function(e) {
        e.preventDefault();
        // var company = jQuery('#company'),
        //     zip_code = jQuery('#zip_code'),
        //     val_zip = /^([1-9]{2}|[0-9][1-9]|[1-9][0-9])[0-9]{3}$/;

        // if(company.val() != null && company.val().length != 0 
        //    && company.val().indexOf(" ") != 0) {
        //     if(zip_code.val().length > 0  ) {
        //         if( val_zip.test( zip_code.val() ) ) {
        //             zip_code = zip_code.val();
        //             console.log('pressed'+zip_code.val());
        //         }
        //     } else{
        //     console.log('pressed');

        //     }
        // }
        
        jQuery("#form").validate({
            rules: {
                company: "required",
                zip_code: {
                    required: false,
                    digits: true,
                    minlength: 5
                },
                website: {
                    url: true,
                    required: false
                },
                rfc: {
                    minlength: 10,
                    maxlength:13,
                    required: false
                }
            },
            messages: {
                company: "Ingrese el nombre de la empresa",
                zip_code: "Este campo debe tener 5 números.",
                website: "Entre una url válida.",
                rfc: "R.F.C. inválido."
            }
        });
        

        if(jQuery("#form").valid()) {
             jQuery.ajax({
                url: '{{=URL('vendors', 'update_vendor')}}',
                data: { 
                    company:jQuery('#company').val(),
                    address:jQuery('#address').val(),
                    state:jQuery('#states').val(),
                    municipality:jQuery('#municipality').val(),
                    locality:jQuery('#locality').val(),
                    zip_code:jQuery('#zip_code').val(),
                    rfc:jQuery('#rfc').val(),
                    website:jQuery('#website').val()
                },
                type: 'POST',
                success:function(data){
                    if(data){
                        jQuery('.msg').html('').fadeIn().html('Se han guardado los datos.').delay(1600).fadeOut();
                    }
                    else{
                        jQuery('.msg').html('').fadeIn().html('Ocurrio un error.').delay(1600).fadeOut();
                    }
                }
            }); 
        }
    });

    
</script>

</body>
</html>
{{end}}
