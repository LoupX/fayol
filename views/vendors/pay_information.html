{{extend 'base/layout.html'}}

{{block scripts_extra}}	
<script type="text/javascript" src="{{=URL('static', 'js/plugins/jquery.validate.min.js')}}"></script>
<script type="text/javascript" src="{{=URL('static', 'js/plugins/chosen.jquery.min.js')}}"></script>
<style type="text/css">
    .ellol {
        border: 1px solid red;
    }    
</style>
{{end}}

{{block sidebar_menu}}
{{include 'vendors/sidebar.html'}}
{{end}}

{{block content}}
    <div class="centercontent">
    
        <div class="pageheader">
        
            <h1 class="pagetitle">{{=title}}</h1>
            
        </div><!--pageheader-->
        
        <div id="contentwrapper" class="contentwrapper">
	   		
	   		<div class="contenttitle2">
	              <h3>Selecciona un proveedor</h3>
            </div><!--contenttitle--> 
                <div class="notibar msgerror" style="display:none;">
                        <a class="close"></a>
                        <p>Ocurrió un error con los datos del formulario.</p>
                </div>

                <div class="notibar msgsuccess" style="display:none;">
                        <a class="close"></a>
                        <p>Se han guardado los datos del formulario.</p>
                    </div>           	
				<div id="validation" class="subcontent">
				
				<form id="form1" class="stdform stdform2" method="post">
                    	                        
                        <p>
                        	<label>Proveedor</label>
                            <span class="field">
                                <select id="selection" name="selection" data-placeholder="Seleccionar" class="chzn-select" style="width:350px;" tabindex="1">
                                </select>
                            </span>
                        </p>
                        
                    <br />
				
					<div class="contenttitle2">
                        <h3>Información de pago</h3>
                    </div><!--contenttitle-->
            	
                        <p>
                        	<label>Banco</label>
                            <span class="field">
                                <select id="bank" name="bank" data-placeholder="Seleccionar" class="chzn-select" style="width:350px;" tabindex="2">
                                </select>
                            </span>
                        </p>
                        
                        <p style="margin-top: 1px;">
                        	<label>Número de Sucursal</label>
                            <span class="field"><input type="text" name="branch" id="branch" class="smallinput" tabindex="3" maxlength="4"/></span>
                        </p>
                        
                        <p>
                        	<label>Número de cuenta</label>
                            <span class="field"><input type="text" name="acountnumber" id="acountnumber" class="smallinput" tabindex="4" maxlength="11"/></span>
                        </p>
                        
                        <p>
                        	<label>CLABE</label>
                            <span class="field"><input type="text" name="clabe" id="clabe" class="smallinput" maxlength="18" tabindex="5"/></span>
                        </p>
                        
                        <p class="stdformbutton">
                        	<button class="submit radius2" id="submit">Guardar</button>
                        </p>
                    </form>

            </div><!--subcontent-->      
        
        </div><!--contentwrapper-->
        
        <br clear="all" />
        
	</div><!-- centercontent -->
    
    
</div><!--bodywrapper-->

<script type="text/javascript">
//executes these ajax when document is loaded
//
jQuery(".chzn-select").chosen();

var vendors = jQuery('#selection') ,
    banks = jQuery('#bank'),
    id = 0;

////// get vendors //////
jQuery.ajax({
    url: "{{=URL(c='vendors_ajax', f='get_vendors')}}",
    type: "POST",
    success:function(data){
      vendors
        .append('<option value="">Selecccionar</option>')
        .append(data)
         .trigger("liszt:updated");
    }
});     
////// get banks //////
jQuery.ajax({
    url: "{{=URL(c='common', f='get_banks')}}",
    type: "POST",
    success:function(data){
      banks
        .append('<option value="">Selecccionar</option>')
        .append(data)
        .trigger("liszt:updated");
    }
}); 

vendors.change( function() {
    id = jQuery(this).find(':selected').val();
    console.log(id);
    var ibank = jQuery('#bank'),
        ibranch = jQuery('#branch'),
        iaccount = jQuery('#acountnumber'),
        iclabe = jQuery('#clabe');

    ibranch.empty();
    iaccount.empty();
    iclabe.empty();
    ibank
        .find('option[value=""]')
        .attr('selected',true)
        .trigger("liszt:updated");

    jQuery.ajax({
        url: "{{=URL(c='vendors_ajax', f='get_vendor_information')}}",
        data: { id:id },
        type: "POST",
        dataType:"json",
        success:function(data){
            ibranch.val(data.vendors['branch']);
            iaccount.val(data.vendors['bank_account_number']);
            iclabe.val(data.vendors['clabe']);
            ibank
                .find("option[value="+data.vendors['id']+"]")
                .attr('selected',true)
                .change()
                .trigger("liszt:updated");
        }
    });

});


 jQuery('#submit').live('click', function(e){
        e.preventDefault();
        jQuery('.msgerror').hide();
        jQuery('.msgsuccess').hide();

        var form = jQuery("#form1"),
            bank_id = jQuery('#bank').val(),
            branch = jQuery('#branch').val(),
            acountnumber = jQuery('#acountnumber').val(),
            clabe = jQuery('#clabe').val();

        form.validate({
            rules: {
                clabe: {
                    required: false,
                    digits: true,
                    maxlength: 18,
                    minlength: 18
                },
                acountnumber: {
                    required: false,
                    digits: true,
                    maxlength: 11,
                    minlength: 11
                },
                branch: {
                    required: false,
                    digits: true,
                    maxlength: 4
                }
            },
            messages: {
                clabe: "Se requiere 18 digitos.",
                acountnumber: "Se requiere 11 digitos",
                branch: "Se requiere maximo 4 digitos."

            }
        });


        if(form.valid() && valSelec(id)) {
            jQuery.ajax({
                url: "{{=URL(c='vendors_ajax', f='update_pay_information')}}",
                data: {
                    bank_id:bank_id,
                    branch:branch,
                    account_number:acountnumber,
                    clabe:clabe,
                    id:id,
                },
                type: "POST",
                success:function(data){
                  if(data){
                        jQuery('.msgsuccess').fadeIn(1600);
                        deleteFields();
                        id = id;
                    }
                    else{
                        jQuery('.msgerror').fadeIn(1600);
                    }
                    jQuery('body','html',window).animate(
                                                        {scrollTop:0}, 
                                                        1000);
                }
            });  
        } else {
            jQuery('.msgerror').fadeIn(1600);
            jQuery('body','html',window).animate(
                                                {scrollTop:0}, 
                                                1000);
        }

});

function deleteFields() {
        jQuery('#acountnumber').val('');
        jQuery('#branch').val('');
        jQuery('#clabe').val('');
        jQuery('#selection')
            .find('option[value=""]')
            .attr('selected',true)
            .trigger("liszt:updated");
        jQuery('#bank')
            .find('option[value=""]')
            .attr('selected',true)
            .trigger("liszt:updated");
    }
function valSelec(s) {
    var bol;
    if (s != 0) {
        bol = true;
        jQuery('#selection').siblings('div').removeClass('ellol');
    } else{
        bol = false;
        jQuery('#selection').siblings('div').addClass('ellol');
    };
    return bol
}
            
            
</script>

</body>
</html>
{{end}}